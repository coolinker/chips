<!DOCTYPE html>
<meta charset="utf-8">
<style>
    body {
        font: 10px sans-serif;
    }
    
    .bar rect {
        fill: steelblue;
    }
    
    .bar text.value {
        fill: white;
    }
    
    .axis {
        shape-rendering: crispEdges;
    }
    
    .axis path {
        fill: none;
    }
    
    .x.axis line {
        stroke: #fff;
        stroke-opacity: .8;
    }
    
    .y.axis path {
        stroke: black;
    }
</style>

<body>
    <script src="//d3js.org/d3.v3.min.js"></script>
    <script>
        var origin = window.location.search.match(/(?:origin=)(\*|[A-Za-z0-9._-]+)/g);
        origin = origin ? origin[0].split('=')[1] : null;
        var batch = window.location.search.match(/(?:batch=)(\*|[A-Za-z0-9._-]+)/g);
        batch = batch ? batch[0].split('=')[1] : null;
        var url = "/kitchen";
        d3.json(url, function (err, data) {
            var keys = ['count'];
            data = data.children;
            // data.sort(function (a, b) {
            //     return b.count - a.count;
            // })
            data = data.slice(0, 150);
            var m = [30, 10, 10, 500],
                w = 960 - m[1] - m[3],
                h = data.length * 15 - data.length - m[0] - m[2];

            var format = d3.format(",.0f");

            var x = d3.scale.linear().range([0, w]),
                y = d3.scale.ordinal().rangeRoundBands([0, h], .1);

            var xAxis = d3.svg.axis().scale(x).orient("top").tickSize(-h),
                yAxis = d3.svg.axis().scale(y).orient("left").tickSize(0);

            var svg = d3.select("body").append("svg")
                .attr("width", w + m[1] + m[3])
                .attr("height", h + m[0] + m[2])
                .append("g")
                .attr("transform", "translate(" + m[3] + "," + m[0] + ")");



            // Parse numbers, and sort by value.
            data.forEach(function (d) { d.value = +d.count; });
            data.sort(function (a, b) { return b.value - a.value; });

            // Set the scale domain.
            x.domain([0, d3.max(data, function (d) { return d.value; })]);
            y.domain(data.map(function (d) { return d.key; }));

            var bar = svg.selectAll("g.bar")
                .data(data)
                .enter().append("g")
                .attr("class", "bar")
                .attr("transform", function (d) {
                    return "translate(0," + y(d.key) + ")";
                });

            bar.append("rect")
                .attr("width", function (d) { return x(d.value); })
                .attr("height", y.rangeBand());

            bar.append("text")
                .attr("class", "value")
                .attr("x", function (d) { return x(d.value); })
                .attr("y", y.rangeBand() / 2)
                .attr("dx", -3)
                .attr("dy", ".35em")
                .attr("text-anchor", "end")
                .text(function (d) { return format(d.value); });

            svg.append("g")
                .attr("class", "x axis")
                .call(xAxis);

            svg.append("g")
                .attr("class", "y axis")
                .call(yAxis);
        }).header("Content-Type", "application/json")
            .send("POST", JSON.stringify({ 'dish': 'single-piece', 'batch': batch, 'origin':origin}));
    </script>

</body>