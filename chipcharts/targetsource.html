<!DOCTYPE html>
<meta charset="utf-8">
<style>
    .link {
        stroke: #aaa;
    }
    
    .node {
        pointer-events: all;
        stroke: none;
        stroke-width: 40px;
    }
</style>

<body>
    <svg width="1280" height="960"></svg>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script>
        var origin = window.location.search.match(/(?:origin=)(\*|[A-Za-z0-9._-]+)/g);
        origin = origin ? origin[0].split('=')[1] : null;
        var batch = window.location.search.match(/(?:batch=)(\*|[A-Za-z0-9._-]+)/g);
        batch = batch ? batch[0].split('=')[1] : null;

        var color = d3.scaleLinear()
            .domain([-1, 30])
            .range(["rgb(80%,80%,80%)", "rgb(10%,10%,10%)"])
            .interpolate(d3.interpolateHcl);

        var morecolor = d3.scaleLinear()
            .domain([-1, 30])
            .range(["rgb(80%,100%,80%)", "rgb(10%,80%,10%)"])
            .interpolate(d3.interpolateHcl);
        var lesscolor = d3.scaleLinear()
            .domain([-1, 30])
            .range(["rgb(100%,80%,80%)", "rgb(80%,10%,10%)"])
            .interpolate(d3.interpolateHcl);

        var svg = d3.select("svg"),
            width = +svg.attr("width"),
            height = +svg.attr("height"),
            node,
            link;

        var simulation = d3.forceSimulation()
            .force("link", d3.forceLink().id(function (d, i) {
                return d.name;
            }).distance(function (d) {
                return 100
            }).strength(0.01))
            .force("gravity", function (d) {
                return 0
            })
            .force("charge", function (d) {
                return -100
            })
            .force("center", d3.forceCenter(width / 2, height / 2));

        d3.json("/kitchen", function (err, data) {
            var links = [], nodes = [], nodesMap = {};
            var maxcount = 0;
            var leafcount = 0;
            function treeToLinksNodes(treeNodes, isroot) {
                treeNodes.forEach(function (item) {
                    var itemkey = item.key;
                    // if (itemkey === "mail.compose.to.input") debugger;
                    // if (item.count<1) return;
                    if (!nodesMap[itemkey]) {
                        maxcount = Math.max(maxcount, item.count);
                        nodes.push(nodesMap[itemkey] = { id: itemkey, name: itemkey, count: item.count, isLeaf: !item.children, isRoot: isroot });
                        if (isroot) {
                            nodesMap[itemkey].fx = 100;
                            nodesMap[itemkey].fy = 400;
                            nodesMap[itemkey].fixed = true;
                        }

                        if (nodesMap[itemkey].isLeaf) {
                            nodesMap[itemkey].fx = 900;
                            nodesMap[itemkey].fy = 100 + (leafcount++) * 100 + Math.min(500, 40 * nodesMap[itemkey].count);
                            nodesMap[itemkey].fixed = true;
                        }

                    } else {
                        nodesMap[itemkey].count += item.count;
                    }

                    if (item.children) {
                        item.children.forEach(function (citem) {
                            // if (citem.key === "mail.compose.to.input") debugger;
                            // if (citem.count>0)
                            links.push({ source: itemkey, target: citem.key, tgtcount: citem.count, count: item.count })
                        });
                        treeToLinksNodes(item.children, false);
                    }


                });

            }

            treeToLinksNodes(data.children, true);
            links.forEach(function (link) {
                link.targetNode = nodesMap[link.target];
                link.sourceNode = nodesMap[link.source];

            });
            update(links, nodes, maxcount)
        }).header("Content-Type", "application/json")
            .send("POST", JSON.stringify({ 'dish': 'targetSource', 'rootkey': 'login.button', 'granularity': '20', 'batch': batch, 'origins': origin }));

        function update(links, nodes, maxcount) {
            link = svg.selectAll(".link")
                .data(links, function (d) {
                    return d.target.id;
                })

            link = link.enter()
                .append("line")
                .attr("class", "link")
                .attr("stroke-width", function (d) {
                    return 1
                });

            node = svg.selectAll(".node")
                .data(nodes, function (d) {
                    debugger;
                    return d.id;
                })

            node = node.enter()
                .append("g")
                .attr("class", "node")
                //.on("click", click)
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));

            node.append("circle")
                .attr("r", function (d) {
                    var r = Math.sqrt(Math.sqrt(d.count / (maxcount)));
                    return Math.max(2.5, Math.round(r * 30));
                }).style("fill", function (d) {
                    if (d.isRoot) return '#0a0';
                    if (d.isLeaf) return '#c00';
                    return color(d.count*30 / maxcount)
                });

            node.append("title")
                .text(function (d) { return d.name + '\n' + d.count; });

            node.append("text")
                .attr("dy", 0)
                .style("fill", function (d) {
                    if (d.isRoot) return '#666';
                    if (d.isLeaf) return '#666';
                    return '#aaa'
                })
                .text(function (d) {
                    // return d.name;
                    return (d.isLeaf || d.isRoot) ? d.name : '';
                });

            simulation
                .nodes(nodes)
                .on("tick", ticked);

            simulation.force("link")
                .links(links);
        }

        function click(d) {
            nodes.push({ id: index, name: "server " + index });
            links.push({ source: d.id, target: index });
            index++;
            update();
        }

        function ticked() {
            link
                .attr("x1", function (d) { return d.source.x; })
                .attr("y1", function (d) { return d.source.y; })
                .attr("x2", function (d) { return d.target.x; })
                .attr("y2", function (d) { return d.target.y; });

            node
                .attr("transform", function (d) { return "translate(" + d.x + ", " + d.y + ")"; });
        }

        function dragstarted(d) {
            if (!d3.event.active) simulation.alphaTarget(0.3).restart()
        }

        function dragged(d) {
            d.fx = d3.event.x;
            d.fy = d3.event.y;
        }

        function dragended(d) {
            if (!d3.event.active) simulation.alphaTarget(0);
            if (!d.fixed) {
                d.fx = undefined;
                d.fy = undefined;
            }

        }
    </script>