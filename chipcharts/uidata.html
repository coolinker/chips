<!DOCTYPE html>
<meta charset="UTF-8">
<style>
    body,
    html {
        height: 100%;
    }
    
    .link {
        fill: none;
    }
</style>

<body style="background-color:beige;margin:0px">
    <div style="display: -webkit-flex;display: flex;-webkit-flex-direction: column;flex-direction: column;width: 100%;height: 250%;">
        <div id="top" style="width:100%;height:50px;font-size:2em;border-color:#ccc; border-bottom-style: solid;;border-width:1px;">UI Data Analytics
        </div>
        <div style="width:100%;flex: 1.3;-webkit-flex: 1.3;display: -webkit-flex;display: flex;-webkit-flex-direction: row;flex-direction: row; padding:10px">
            <div id="pack" style="width:500px;height:100%;flex:1.2;-webkit-flex:1.2;border-width:1px; border-color:#ccc; border-right-style: solid;">
                <span style="position:absolute">User Path Diff</span>
            </div>
            <div id="net" style="height:100%;flex:2;-webkit-flex: 2;border-width:1px; border-color:#ccc; border-right-style: solid;">
                <span id="netlabel" style="position:absolute">Motion of Mouse</span>
            </div>
        </div>
        
        <div id="tree" style="width:100%;flex: 1.3;-webkit-flex: 1.3;border-top-style: solid;border-width:1px; border-color:#ccc;padding:10px">
            <span style="position:absolute">User Path Diff</span>
            <span id="labels" style="position:absolute;right:20px;text-align:right;"></span>
        </div>
        <div style="width:100%;flex: 1;-webkit-flex: 1;display: -webkit-flex;display: flex;-webkit-flex-direction: row;flex-direction: row;padding:10px">
            <div id="plot" style="height:100%;flex: 2;-webkit-flex: 2;border-top-style: solid;border-width:1px; border-color:#ccc; border-right-style: solid;padding:10px">
                <span style="position:absolute">Performance(lag between actions)</span>
            </div>
            <div id="lagDistribution" style="height:100%;flex: 1;-webkit-flex:1;border-top-style: solid;border-width:1px; border-color:#ccc;padding:10px">
                <span style="position:absolute">Lag Distribution</span>
            </div>
        </div>
        
        <div style="width:100%;flex: 1.3;-webkit-flex: 1.3;display: -webkit-flex;display: flex;-webkit-flex-direction: row;flex-direction: row;padding:10px">
            <div id="sankey1" style="height:100%;flex: 1;-webkit-flex: 1;border-right-style: solid;;border-top-style: solid;border-width:1px; border-color:#ccc;padding:10px">
                <span style="position:absolute">Effectiveness - <span style="font-size: 0.5em;">[Composing Message]</span></span>
            </div>
            
        </div>
        <div style="width:100%;flex: 1.3;-webkit-flex: 1.3;display: -webkit-flex;display: flex;-webkit-flex-direction: row;flex-direction: row;padding:10px">
            <div id="sankey2" style="height:100%;flex: 1;-webkit-flex:1;padding:10px;border-top-style: solid;border-width:1px; border-color:#ccc;">
                <span style="position:absolute">Effectiveness - <span style="font-size: 0.5em;">[Creating Contact]</span></span>
            </div>
        </div>
        <div style="width:100%;flex: 1;-webkit-flex: 1;display: -webkit-flex;display: flex;-webkit-flex-direction: row;flex-direction: row;padding:10px">
            <div id="efficiency" style="height:100%;flex: 1;-webkit-flex:1;padding:10px;border-top-style: solid;border-width:1px; border-color:#ccc;">
                <span style="position:absolute">Efficiency...</span>
            </div>
        </div>
    </div>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="pathtree.js"></script>
    <script src="pathpacking.js"></script>
    <script src="pathnet.js"></script>
    <script src="lagbubble.js"></script>
    <script src="distributionbar.js"></script>
    <script src="sankey.js"></script>
    <script src="effectivenesssankey.js"></script>
    
    <script>
        var origin = window.location.search.match(/(?:[^A-Za-z0-9._-]origin=)(\*|[A-Za-z0-9._-]+)/g);
        origin = origin ? [origin[0].split('=')[1]] : null;
        var difforigin = window.location.search.match(/(?:difforigin=)(\*|[A-Za-z0-9._-]+)/g);
        difforigin = difforigin ? difforigin[0].split('=')[1] : null;
        var batch = window.location.search.match(/(?:batch=)(\*|[A-Za-z0-9._-]+)/g);
        batch = batch ? batch[0].split('=')[1] : null;
        //PathPacking.createInstance('pack1').loadData("login.button", 5, batch, origin, difforigin);
        var pathPacking = PathPacking.createInstance('pack').loadData("login.button", 5, batch, origin, difforigin);
        var pathTree = PathTree.createInstance('tree').loadData("login.button", 5, batch, origin, difforigin);
        var pathNet = PathNet.createInstance('net').loadData("login.button", 5, batch, origin, difforigin);
        var lagBubble = LagBubble.createInstance('plot').loadData("login.button", 10, batch, origin);
        var effectivenessSankey1 = EffectivenessSankey.createInstance('sankey1').loadData(['mail.toolbar.compose.button','contacts.compose.button','mail.toolbar.reply.button'], ['mail.compose.send.button', 'mail.compose.discard.button', 'toolbar.close.button', 'browser.beforeunload'], 20, batch, origin);
        var effectivenessSankey2 = EffectivenessSankey.createInstance('sankey2').loadData(['contacts.toolbar.new.button','contacts.form.toolbar.edit.button'], ['contacts.form.toolbar.save.button', 'contacts.form.toolbar.cancel.button', 'browser.beforeunload'], 20, batch, origin);
        
        var distributionBar = DistributionBar.createInstance('lagDistribution');

        lagBubble.onLagDetail = function (d) {
            distributionBar.loadData([d.source.data.key], [d.target.data.key], 10, batch, origin);
        }

        pathTree.setUpdateHandler(function (d) {
            var p = d;
            var arr = [p.data.key];
            while (p = p.parent) {
                arr.push(p.data.key);
            }
            arr.reverse();
            pathPacking.zoomToNode(arr.concat());
            pathNet.updateEntry(arr.concat());
            document.getElementById('netlabel').innerHTML = 'Motion of Mouse <span style="color:#ccc"> @' + d.data.key + '</span>';
            updateLabels(d);
        })

        function updateLabels(d) {
            var p = d;
            var arr = [p];
            var maxCount = p.data.count;
            var maxLag = p.data.lag;
            while (p = p.parent) {
                arr.push(p);
                maxCount = Math.max(maxCount, p.data.count);
                maxLag = Math.max(maxLag, p.data.lag);
            }
            maxCount = Math.pow(maxCount, 0.3);
            maxLag = Math.pow(maxLag, 0.3);
            arr.reverse();

            var str = '';
            for (var i = 0; i < arr.length; i++) {
                var n = arr[i];
                var s = n.data.count;
                s = Math.max(0.1, 2 * Math.pow(s, 0.25) / maxCount);
                var l = n.data.lag;
                l = Math.round(Math.max(0, 200 * Math.pow(l, 0.3) / maxLag));
                c = 'rgb(' + l + ',' + l + ',' + l + ')';

                str += '<span style="color:' + c + ';font-size:' + s + 'em;margin:-0.3em;">' + n.data.key + '</span></br>'
            }

            document.getElementById('labels').innerHTML = str;
        }
    </script>
</body>